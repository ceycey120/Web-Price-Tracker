import sqlite3
from datetime import datetime
from tabulate import tabulate

class PriceDataManager:
    def __init__(self, db="prices.db"):
        self.db = db
        self.create_tables()

    def create_tables(self):
        self._execute("""
            CREATE TABLE IF NOT EXISTS products (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT UNIQUE NOT NULL
            )
        """)
        self._execute("""
            CREATE TABLE IF NOT EXISTS prices (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                product_id INTEGER NOT NULL,
                price REAL NOT NULL,
                date TEXT NOT NULL,
                FOREIGN KEY(product_id) REFERENCES products(id)
            )
        """)

    def _execute(self, query, params=(), fetch=False):
        with sqlite3.connect(self.db) as conn:
            cur = conn.cursor()
            cur.execute(query, params)
            return cur.fetchall() if fetch else None

    # ---------------- PRODUCT FUNCTIONS ---------------- #

    def add_product(self, name):
        self._execute("INSERT OR IGNORE INTO products (name) VALUES (?)", (name,))
        result = self._execute("SELECT id FROM products WHERE name = ?", (name,), fetch=True)
        return result[0][0]  # return product ID

    # ---------------- PRICE FUNCTIONS ------------------- #

    def add_price(self, product_name, price, date=None):
        product_id = self.add_product(product_name)
        date = date or datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self._execute(
            "INSERT INTO prices (product_id, price, date) VALUES (?, ?, ?)",
            (product_id, price, date)
        )

    def get_price_history(self):
        return self._execute("""
            SELECT products.name, prices.price, prices.date
            FROM prices
            JOIN products ON prices.product_id = products.id
            ORDER BY prices.date DESC
        """, fetch=True)

    def display_price_history(self):
        data = self.get_price_history()
        print(tabulate(data, headers=["Product", "Price", "Date"], tablefmt="fancy_grid") 
              if data else "No price data available.")


# ------------ Example ------------
if __name__ == "__main__":
    m = PriceDataManager()

    m.add_price("Laptop", 1299.99)
    m.add_price("Smartphone", 799.50)
    m.add_price("Laptop", 1399.99)   # new price, same product
    m.display_price_history()
